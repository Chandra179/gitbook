
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <title>Clock Skew & Time Sync Â· My Blog</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../saas-ideas.html" />
    
    
    <link rel="prev" href="id-generator.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    My Blog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../general/">
            
                <a href="../general/">
            
                    
                    General
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../general/bits-and-bytes.html">
            
                <a href="../general/bits-and-bytes.html">
            
                    
                    Bits & Bytes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../general/character-encoding.html">
            
                <a href="../general/character-encoding.html">
            
                    
                    Character Encoding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../general/nat-and-p2p-traversal.html">
            
                <a href="../general/nat-and-p2p-traversal.html">
            
                    
                    NAT & P2P Traversal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../general/api-design-guidelines.html">
            
                <a href="../general/api-design-guidelines.html">
            
                    
                    API Design Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../general/big-integer.html">
            
                <a href="../general/big-integer.html">
            
                    
                    Big Integer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../general/database.html">
            
                <a href="../general/database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../general/kafka.html">
            
                <a href="../general/kafka.html">
            
                    
                    Kafka
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../golang/">
            
                <a href="../golang/">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../golang/strings.html">
            
                <a href="../golang/strings.html">
            
                    
                    Strings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../golang/goroutine.html">
            
                <a href="../golang/goroutine.html">
            
                    
                    Goroutine
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../rag/">
            
                <a href="../rag/">
            
                    
                    RAG
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../rag/crawling-result.html">
            
                <a href="../rag/crawling-result.html">
            
                    
                    Crawling Result
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../rag/chunking.html">
            
                <a href="../rag/chunking.html">
            
                    
                    Chunking
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../p2p-chat.html">
            
                <a href="../p2p-chat.html">
            
                    
                    P2P Chat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../reactjs.html">
            
                <a href="../reactjs.html">
            
                    
                    ReactJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../math/">
            
                <a href="../math/">
            
                    
                    Math
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../math/basic.html">
            
                <a href="../math/basic.html">
            
                    
                    Basic
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../math/problem.html">
            
                <a href="../math/problem.html">
            
                    
                    Problem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../math/quadratic-equation.html">
            
                <a href="../math/quadratic-equation.html">
            
                    
                    Quadratic Equation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../math/polynomial.html">
            
                <a href="../math/polynomial.html">
            
                    
                    Polynomial
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="template-component-design.html">
            
                <a href="template-component-design.html">
            
                    
                    Topic Breakdown
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="./">
            
                <a href="./">
            
                    
                    System Design
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="template-high-level-design.html">
            
                <a href="template-high-level-design.html">
            
                    
                    [Template] High Level Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="consistent-hashing.html">
            
                <a href="consistent-hashing.html">
            
                    
                    Consistent Hashing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="id-generator.html">
            
                <a href="id-generator.html">
            
                    
                    ID Generator
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9.4" data-path="clock-skew-and-time-sync.html">
            
                <a href="clock-skew-and-time-sync.html">
            
                    
                    Clock Skew & Time Sync
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../saas-ideas.html">
            
                <a href="../saas-ideas.html">
            
                    
                    SaaS Ideas
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Clock Skew & Time Sync</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="clock-skew--time-sync">Clock Skew &amp; Time Sync</h1>
<h3 id="what-is-clock-skew">What is Clock Skew?</h3>
<p>Clock Skew is the phenomenon where the local system clock on a specific server drifts away from the actual, absolute time (Universal Coordinated Time or UTC). In a distributed system, "Time" is not a constant. Each server relies on a physical hardware component (a quartz crystal oscillator) to keep time. These crystals are imperfect and are affected by temperature, voltage, and age.</p>
<ul>
<li>Drift: The gradual divergence of the local clock from true time (e.g., drifting +0.5 seconds per day).</li>
<li>Skew: The instantaneous difference between the local clock and the reference time.</li>
</ul>
<h3 id="what-and-why-use-ntp">What and Why Use NTP?</h3>
<p>If hardware clocks are inaccurate, we use NTP (Network Time Protocol) to fix them. NTP runs as a daemon on the server, periodically checking the time against highly accurate atomic clocks over the internet. We must use NTP because accurate time is required for:</p>
<ol>
<li>Log correlation (Debugging across services).</li>
<li>Database consistency (Last-write-wins conflict resolution).</li>
<li>Security tokens (JWT expiration).</li>
</ol>
<p>However, NTP is also the primary cause of the specific failure mode that threatens Snowflake IDs. If NTP detects the local clock is significantly ahead (e.g., 5 seconds fast), it may force the clock to jump backward to align with reality.</p>
<h3 id="causes-of-clock-skew-backward-jumps">Causes of Clock Skew (Backward Jumps)</h3>
<p>For a Snowflake ID generator, a clock moving <em>forward</em> is fine. The danger is when the clock moves <em>backward</em>.</p>
<h4 id="natural-drift-hardware">Natural Drift (Hardware)</h4>
<p>The Root Cause. All computer clocks rely on oscillating crystals (usually quartz) to keep time. Due to tiny differences in manufacturing, temperature variations, and voltage fluctuations, these oscillation rates are never perfectly identical.</p>
<ul>
<li>The Effect: Over time, these clocks naturally drift away from each other and from the absolute "True Time."</li>
<li>The Consequence: This continuous drift is what forces us to use NTP. If the drift becomes significant, it triggers the synchronization events described below.</li>
</ul>
<h4 id="ntp-stepping-the-most-common-cause">NTP "Stepping" (The most common cause)</h4>
<p>NTP usually adjusts time gradually (called "slewing"). However, if the discrepancy is too large (typically &gt;128ms), NTP typically forces a "Step" adjustment. It instantly snaps the system clock backward to the correct time.</p>
<h4 id="virtual-machine-vm-pauses">Virtual Machine (VM) Pauses</h4>
<p>In cloud environments (AWS, GCP), a VM might be paused for "Live Migration" or due to "Noisy Neighbors." When the VM resumes, the CPU clock catches up, but the wall clock might behave erratically or appear to jump relative to the application's execution flow.</p>
<h4 id="manual-admin-intervention">Manual Admin Intervention</h4>
<p>A sysadmin manually resetting the server time using <code>date</code> or <code>timedatectl</code> commands.</p>
<h3 id="impact-on-snowflake-id-generator">Impact on Snowflake ID Generator</h3>
<p>The Snowflake ID relies on the invariant: Time must strictly increase.</p>
<p>If the clock moves backward, the following collision scenario occurs:</p>
<ol>
<li>Time $$T=1000$$: Generator creates <code>ID_A</code> (Timestamp: 1000, Sequence: 0).</li>
<li>Clock Jump: NTP moves clock backward to $$T=999$$.</li>
<li>Time $$T=999$$: Generator creates <code>ID_B</code>.</li>
<li>The Conflict: The system has <em>already</em> generated IDs for Time 999 in the past. If the sequence counter resets to 0, <code>ID_B</code> will be an exact duplicate of an ID generated 1 millisecond ago.</li>
</ol>
<blockquote>
<p>Result: Duplicate Primary Keys $$\rightarrow$$ Database constraint violation $$\rightarrow$$ Transaction Failure.</p>
</blockquote>
<h3 id="mitigation-strategies">Mitigation Strategies</h3>
<p>Robust Snowflake implementations must implement "Refusal to Generate" logic when clock skew is detected.</p>
<h4 id="strategy-a-the-pause-and-wait-recommended-for-small-skews">Strategy A: The "Pause and Wait" (Recommended for Small Skews)</h4>
<p>If the backward jump is small (e.g., &lt; 5 seconds), the system pauses execution and waits for the clock to catch up.</p>
<h4 id="strategy-b-the-hard-fail-integrity-first">Strategy B: The "Hard Fail" (Integrity First)</h4>
<p>For financial systems, it is often safer to crash the service pod than to risk a duplicate ID. Kubernetes or the load balancer will route traffic to a healthy node while the affected node restarts.</p>
<h4 id="strategy-c-monotonic-clock-check">Strategy C: Monotonic Clock Check</h4>
<p>Do not rely solely on <code>Wall Clock</code> (System Time). Use the OS <code>Monotonic Clock</code> (time since boot) to measure elapsed time.</p>
<ul>
<li>Verify that if <code>Wall Clock</code> moved backward, <code>Monotonic Clock</code> still moved forward.</li>
<li>Note: You still cannot generate an ID with a past timestamp, but this helps accurately measure <em>how long</em> to wait.</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="id-generator.html" class="navigation navigation-prev " aria-label="Previous page: ID Generator">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../saas-ideas.html" class="navigation navigation-next " aria-label="Next page: SaaS Ideas">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Clock Skew & Time Sync","level":"1.9.4","depth":2,"next":{"title":"SaaS Ideas","level":"1.10","depth":1,"path":"saas-ideas.md","ref":"saas-ideas.md","articles":[]},"previous":{"title":"ID Generator","level":"1.9.3","depth":2,"path":"system-design/id-generator.md","ref":"system-design/id-generator.md","articles":[]},"dir":"ltr"},"config":{"plugins":["hints"],"root":"./","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Blog","language":"en","gitbook":"*"},"file":{"path":"system-design/clock-skew-and-time-sync.md","mtime":"2025-12-06T08:55:36.834Z","type":"markdown"},"gitbook":{"version":"6.1.4","time":"2025-12-06T11:33:05.637Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

