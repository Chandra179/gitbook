
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <title>Goroutine ¬∑ My Blog</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.1.4">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../rag/" />
    
    
    <link rel="prev" href="strings.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    My Blog
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../general/">
            
                <a href="../general/">
            
                    
                    General
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../general/bits-and-bytes.html">
            
                <a href="../general/bits-and-bytes.html">
            
                    
                    Bits & Bytes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../general/character-encoding.html">
            
                <a href="../general/character-encoding.html">
            
                    
                    Character Encoding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../general/nat-and-p2p-traversal.html">
            
                <a href="../general/nat-and-p2p-traversal.html">
            
                    
                    NAT & P2P Traversal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../general/api-design-guidelines.html">
            
                <a href="../general/api-design-guidelines.html">
            
                    
                    API Design Guidelines
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../general/big-integer.html">
            
                <a href="../general/big-integer.html">
            
                    
                    Big Integer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="../general/database.html">
            
                <a href="../general/database.html">
            
                    
                    Database
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="../general/kafka.html">
            
                <a href="../general/kafka.html">
            
                    
                    Kafka
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Golang
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="strings.html">
            
                <a href="strings.html">
            
                    
                    Strings
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="goroutine.html">
            
                <a href="goroutine.html">
            
                    
                    Goroutine
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../rag/">
            
                <a href="../rag/">
            
                    
                    RAG
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../rag/crawling-result.html">
            
                <a href="../rag/crawling-result.html">
            
                    
                    Crawling Result
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../rag/chunking.html">
            
                <a href="../rag/chunking.html">
            
                    
                    Chunking
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../p2p-chat.html">
            
                <a href="../p2p-chat.html">
            
                    
                    P2P Chat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../reactjs.html">
            
                <a href="../reactjs.html">
            
                    
                    ReactJS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../math/">
            
                <a href="../math/">
            
                    
                    Math
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../math/basic.html">
            
                <a href="../math/basic.html">
            
                    
                    Basic
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../math/problem.html">
            
                <a href="../math/problem.html">
            
                    
                    Problem
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../math/quadratic-equation.html">
            
                <a href="../math/quadratic-equation.html">
            
                    
                    Quadratic Equation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../math/polynomial.html">
            
                <a href="../math/polynomial.html">
            
                    
                    Polynomial
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../system-design/template-component-design.html">
            
                <a href="../system-design/template-component-design.html">
            
                    
                    Topic Breakdown
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../system-design/">
            
                <a href="../system-design/">
            
                    
                    System Design
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../system-design/template-high-level-design.html">
            
                <a href="../system-design/template-high-level-design.html">
            
                    
                    [Template] High Level Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../system-design/consistent-hashing.html">
            
                <a href="../system-design/consistent-hashing.html">
            
                    
                    Consistent Hashing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../system-design/id-generator.html">
            
                <a href="../system-design/id-generator.html">
            
                    
                    ID Generator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../system-design/clock-skew-and-time-sync.html">
            
                <a href="../system-design/clock-skew-and-time-sync.html">
            
                    
                    Clock Skew & Time Sync
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../saas-ideas.html">
            
                <a href="../saas-ideas.html">
            
                    
                    SaaS Ideas
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Goroutine</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="goroutine">Goroutine</h1>
<h2 id="gpm-scheduler">GPM scheduler</h2>
<figure><img src="../.gitbook/assets/gpm.png" alt=""></img><figcaption></figcaption></figure>

<ul>
<li><strong>G (Goroutine)</strong> ‚Üí the task itself (like a cooking order). You create a goroutine whenever you want to run a function concurrently. Example: <code>G1</code>, <code>G2</code>, <code>G3</code>.</li>
<li><strong>P (Processor)</strong> ‚Üí the scheduler‚Äôs ‚Äúcooking station.‚Äù It decides which goroutine should run on which OS thread. Example: <code>P1</code>, <code>P2</code>.</li>
<li><strong>M (Machine / OS Thread)</strong> ‚Üí the chef who executes the task. Example: <code>M1</code>, <code>M2</code>.</li>
</ul>
<h4 id="work-stealing-load-balancing"><strong>Work Stealing (Load Balancing):</strong></h4>
<ul>
<li>Each P has a Local Run Queue.</li>
<li>If P1 runs out of Gs, it doesn't go idle. It checks the Global Run Queue.</li>
<li>If that is empty, it attempts to steal half the Gs from P2‚Äôs queue.</li>
<li><em>Result:</em> All CPU cores stay saturated efficiently.</li>
</ul>
<h4 id="syscall-handoff-preventing-blocking"><strong>Syscall Handoff (Preventing Blocking):</strong></h4>
<ul>
<li>If a Goroutine (G1) makes a blocking syscall (e.g., file I/O), the thread (M1) blocks.</li>
<li>The Scheduler detaches P1 from M1 and moves P1 to a new (or sleeping) thread (M2).</li>
<li>P1 continues executing other goroutines (G2, G3).</li>
<li>When the syscall finishes, M1 tries to re-acquire a P.</li>
<li><em>Result:</em> Thousands of syscalls don‚Äôt starve your CPU.</li>
</ul>
<h2 id="channels-in-go-">Channels in Go <a href="#id-7e3b" id="id-7e3b"></a></h2>
<h4 id="unbuffered-channel-"><strong>Unbuffered channel</strong> <a href="#bb03" id="bb03"></a></h4>
<ul>
<li>Send (<code>ch &lt;- v</code>) blocks until another goroutine is ready to receive (<code>&lt;-ch</code>)</li>
<li>Receive blocks until another goroutine sends</li>
<li>The sender and receiver synchronize at the channel</li>
</ul>
<pre><code class="lang-go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>) <span class="hljs-comment">// unbuffered</span>
ch &lt;- <span class="hljs-string">"apple"</span>           <span class="hljs-comment">// ‚ùå blocks immediately (no receiver)</span>
</code></pre>
<pre><code class="lang-go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)

<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    msg := &lt;-ch
    fmt.Println(<span class="hljs-string">"received:"</span>, msg)
}()

ch &lt;- <span class="hljs-string">"apple"</span> <span class="hljs-comment">// blocks until receiver is ready</span>
</code></pre>
<h4 id="buffered-channel-"><strong>Buffered channel</strong> <a href="#id-63b6" id="id-63b6"></a></h4>
<ul>
<li>Created with <code>make(chan T, n)</code></li>
<li>Capacity <code>n</code> allows sends to succeed without a receiver until the buffer is full</li>
<li>Receiving only blocks when buffer is empty</li>
</ul>
<pre><code class="lang-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">2</span>)

    ch &lt;- <span class="hljs-string">"apple"</span>   
    ch &lt;- <span class="hljs-string">"banana"</span>  
    ch &lt;- <span class="hljs-string">"cherry"</span>  <span class="hljs-comment">// blocks (buffer full)</span>
}
</code></pre>
<pre><code class="lang-go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">2</span>)

<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> ch {
        fmt.Println(<span class="hljs-string">"received:"</span>, v)
    }
}()

ch &lt;- <span class="hljs-string">"apple"</span>
ch &lt;- <span class="hljs-string">"banana"</span>
ch &lt;- <span class="hljs-string">"cherry"</span> <span class="hljs-comment">// waits until receiver drains a slot</span>
</code></pre>
<h4 id="nil-channel-"><strong>Nil channel</strong> <a href="#id-63b6" id="id-63b6"></a></h4>
<p>A channel that is declared but not initialized (or set to nil) has properties:</p>
<ol>
<li>Read: Blocks forever.</li>
<li>Write: Blocks forever.</li>
<li>Close: Panics.</li>
</ol>
<pre><code class="lang-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">merger</span><span class="hljs-params">(in1, in2 &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> in1 != <span class="hljs-literal">nil</span> || in2 != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> v, ok := &lt;-in1:
            <span class="hljs-keyword">if</span> !ok {
                in1 = <span class="hljs-literal">nil</span> <span class="hljs-comment">// üí° Setting to nil disables this case forever!</span>
                <span class="hljs-keyword">continue</span>
            }
            fmt.Println(<span class="hljs-string">"From 1:"</span>, v)
        <span class="hljs-keyword">case</span> v, ok := &lt;-in2:
            <span class="hljs-keyword">if</span> !ok {
                in2 = <span class="hljs-literal">nil</span>
                <span class="hljs-keyword">continue</span>
            }
            fmt.Println(<span class="hljs-string">"From 2:"</span>, v)
        }
    }
}
</code></pre>
<hr></hr>
<h2 id="what-happens-to-blocking-channel-operation-">What happens to blocking channel operation? <a href="#id-6ffe" id="id-6ffe"></a></h2>
<ul>
<li>The goroutine is <strong>suspended</strong> ‚Äî removed from the run queue.</li>
<li>It is placed in the channel‚Äôs <strong>send queue (<code>sendq</code>)</strong> or <strong>receive queue (<code>recvq</code>)</strong>.</li>
<li>Once the corresponding send or receive happens, the goroutine is <strong>resumed</strong>.</li>
</ul>
<p></p><div class="alert alert-info hints-alert"><div class="hints-icon"><i class="fa fa-info-circle"></i></div><div class="hints-container"><p><strong>Note:</strong> No extra data is stored for the goroutine; only a reference in the channel queue.</p>
</div></div><p></p>
<figure><img src="https://miro.medium.com/v2/resize:fit:1094/1*sJ9y0EHlDqpmj7gnWrnL3w.png" alt="" height="436" width="700"></img><figcaption></figcaption></figure>

<h4 id="channel-internals-hchan"><strong>Channel Internals (<code>hchan</code>)</strong></h4>
<p>Each channel keeps:</p>
<ul>
<li><code>buf</code> ‚Üí circular buffer (holds values for buffered channels)</li>
<li><code>sendq</code> ‚Üí queue of goroutines waiting to send</li>
<li><code>recvq</code> ‚Üí queue of goroutines waiting to receive</li>
<li><code>lock</code> ‚Üí mutex for concurrent access</li>
</ul>
<p>Summary<strong>:</strong></p>
<ul>
<li><strong>Buffered channels:</strong> store values in <code>buf</code> until full; blocked senders go into <code>sendq</code></li>
<li><strong>Unbuffered channels:</strong> no buffer; every send waits for a receive (and vice versa)</li>
</ul>
<h2 id="closures-in-goroutine-">Closures in goroutine <a href="#fec9" id="fec9"></a></h2>
<p>Common pitfall: goroutines inside loops capturing the loop variable</p>
<pre><code class="lang-go">numbers := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}

<span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> numbers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(n)
    }()
}
<span class="hljs-comment">// Might print 3, 3, 3 (loop completes before goroutines run)</span>
</code></pre>
<p>The closure captures the loop variable itself, not its value at each iteration. This means that the loop may have already completed before the goroutine has a chance to execute, causing the goroutine to read the final value of the loop variable. To fix this, you can pass the variable as an argument:</p>
<pre><code class="lang-go"><span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> numbers {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(val <span class="hljs-type">int</span>)</span></span> {
        fmt.Println(val)
    }(n) <span class="hljs-comment">// Passing 'n' by value</span>
}
</code></pre>
<p>Since each goroutine has its own unique copy of the value, it doesn‚Äôt matter when the goroutine actually runs. It will always use the value that was passed to it, not the final value of the loop variable.</p>
<h2 id="select-statement">Select Statement</h2>
<p><code>select</code> is a control structure that allows a goroutine to wait on <strong>multiple channel operations</strong> (send or receive) at the same time.</p>
<pre><code class="lang-go"><span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> msg := &lt;-ch1:
    fmt.Println(<span class="hljs-string">"Received from ch1:"</span>, msg)
<span class="hljs-keyword">case</span> ch2 &lt;- <span class="hljs-string">"ping"</span>:
    fmt.Println(<span class="hljs-string">"Sent ping to ch2"</span>)
<span class="hljs-keyword">default</span>:
    fmt.Println(<span class="hljs-string">"No channel ready"</span>)
}
</code></pre>
<h4 id="common-usecases">Common Usecases</h4>
<pre><code class="lang-go"><span class="hljs-comment">// Wait on multiple channels</span>
<span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> msg := &lt;-ch1:
    fmt.Println(<span class="hljs-string">"ch1 said"</span>, msg)
<span class="hljs-keyword">case</span> msg := &lt;-ch2:
    fmt.Println(<span class="hljs-string">"ch2 said"</span>, msg)
}

<span class="hljs-comment">// Using timeout</span>
<span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> result := &lt;-dbResponse:
    fmt.Println(<span class="hljs-string">"Got data:"</span>, result)
<span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">3</span> * time.Second):
    fmt.Println(<span class="hljs-string">"Timeout waiting for DB"</span>)
}

<span class="hljs-comment">// Graceful shutdown</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(ctx context.Context, ch &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> val := &lt;-ch:
            fmt.Println(<span class="hljs-string">"got"</span>, val)
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():
            fmt.Println(<span class="hljs-string">"worker stopped"</span>)
            <span class="hljs-keyword">return</span>
        }
    }
}

<span class="hljs-comment">// Non blocking send</span>
<span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> ch &lt;- <span class="hljs-number">1</span>:
    fmt.Println(<span class="hljs-string">"sent"</span>)
<span class="hljs-keyword">default</span>:
    fmt.Println(<span class="hljs-string">"channel is full, skipping"</span>)
}
</code></pre>
<p>Without <code>select</code>, you‚Äôd need manual checks, polling, or additional goroutines. But with <code>select</code>, Go gives you a built-in language feature that:</p>
<ul>
<li>waits on multiple channels <strong>in a single place</strong></li>
<li>picks whichever channel is ready</li>
<li>prevents your goroutine from blocking forever</li>
</ul>
<pre><code class="lang-go"><span class="hljs-comment">// Without select</span>
<span class="hljs-keyword">for</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ch1) &gt; <span class="hljs-number">0</span> {
        msg := &lt;-ch1
        fmt.Println(<span class="hljs-string">"Got from ch1:"</span>, msg)
    }

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ch2) &gt; <span class="hljs-number">0</span> {
        msg := &lt;-ch2
        fmt.Println(<span class="hljs-string">"Got from ch2:"</span>, msg)
    }

    time.Sleep(<span class="hljs-number">1</span> * time.Millisecond) <span class="hljs-comment">// avoid CPU burn</span>
}

<span class="hljs-comment">// With select</span>
<span class="hljs-keyword">select</span> {
<span class="hljs-keyword">case</span> msg := &lt;-ch1:
    fmt.Println(<span class="hljs-string">"Got from ch1:"</span>, msg)

<span class="hljs-keyword">case</span> msg := &lt;-ch2:
    fmt.Println(<span class="hljs-string">"Got from ch2:"</span>, msg)
}
</code></pre>
<h4 id="tradeoffs--common-mistakes">Tradeoffs &amp; Common mistakes</h4>
<table>
<thead>
<tr>
<th>Benefit</th>
<th>Trade-off / cost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Avoids blocking, prevents deadlocks</td>
<td>Logic becomes more complex as channels grow</td>
</tr>
<tr>
<td>Handles multiple channels elegantly</td>
<td>Hard to test + debug because timing/race conditions</td>
</tr>
<tr>
<td>Enables timeouts + cancellation</td>
<td><code>default</code> can accidentally create busy loops</td>
</tr>
<tr>
<td>Non-blocking I/O</td>
<td>Can hide back-pressure problems if misused</td>
</tr>
</tbody>
</table>
<p>‚ùå Putting heavy logic inside <code>select</code>\
‚ùå Using <code>default</code> without <code>time.Sleep()</code> ‚Üí creates hot loops\
‚ùå Overusing <code>select</code> instead of restructuring goroutines</p>
<h4 id="when-to-use-it">When to use it?</h4>
<table><thead><tr><th width="362.6219482421875">Use it when‚Ä¶</th><th>Don't use it when‚Ä¶</th></tr></thead><tbody><tr><td>Multiple channels might be ready</td><td>You only have 1 channel</td></tr><tr><td>You need timeouts / cancellation</td><td>You‚Äôre doing sequential processing</td></tr><tr><td>You're multiplexing goroutines</td><td>You can avoid concurrency entirely</td></tr></tbody></table>

<h2 id="synchronization-primitives-sync-package">Synchronization Primitives (<code>sync</code> package)</h2>
<h4 id="mutex-syncmutex-vs-syncrwmutex">Mutex (<code>sync.Mutex</code> vs <code>sync.RWMutex</code>)</h4>
<p>Use Mutexes when you need high-performance access to shared state (maps, structs, counters).</p>
<ul>
<li>Mutex: Locks for both read and write.</li>
<li>RWMutex: Allows multiple readers OR one writer. Preferred for read-heavy workloads (e.g., caches).</li>
</ul>
<pre><code class="lang-go"><span class="hljs-keyword">type</span> SafeCounter <span class="hljs-keyword">struct</span> {
    mu sync.RWMutex
    v  <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SafeCounter)</span></span> Inc(key <span class="hljs-type">string</span>) {
    c.mu.Lock()         <span class="hljs-comment">// üîí Write Lock: No one else can read or write</span>
    <span class="hljs-keyword">defer</span> c.mu.Unlock()
    c.v[key]++
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *SafeCounter)</span></span> Value(key <span class="hljs-type">string</span>) <span class="hljs-type">int</span> {
    c.mu.RLock()        <span class="hljs-comment">// üîì Read Lock: Others can read, but no one can write</span>
    <span class="hljs-keyword">defer</span> c.mu.RUnlock()
    <span class="hljs-keyword">return</span> c.v[key]
}
</code></pre>
<h4 id="waitgroup-syncwaitgroup">WaitGroup (<code>sync.WaitGroup</code>)</h4>
<p>Calling <code>Add(1)</code> <em>inside</em> the goroutine. This creates a race condition where <code>Wait()</code> might finish before the goroutine starts.</p>
<pre><code class="lang-go"><span class="hljs-keyword">var</span> wg sync.WaitGroup

<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    wg.Add(<span class="hljs-number">1</span>) <span class="hljs-comment">// ‚úÖ Correct: Add BEFORE starting goroutine</span>
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(id <span class="hljs-type">int</span>)</span></span> {
        <span class="hljs-keyword">defer</span> wg.Done()
        fmt.Printf(<span class="hljs-string">"Worker %d starting\n"</span>, id)
    }(i)
}

wg.Wait() <span class="hljs-comment">// Blocks until counter is 0</span>
</code></pre>
<h4 id="atomic-operations-syncatomic">Atomic Operations (<code>sync/atomic</code>)</h4>
<p>For simple counters or boolean flags, Mutex is overkill. Atomics use low-level CPU instructions (CAS - Compare And Swap). They are ~10x faster than Mutex but harder to read.</p>
<pre><code class="lang-go"><span class="hljs-keyword">var</span> ops atomic.Int64 <span class="hljs-comment">// Go 1.19+ types</span>

<span class="hljs-comment">// Inside goroutine</span>
ops.Add(<span class="hljs-number">1</span>)

<span class="hljs-comment">// Reading</span>
fmt.Println(<span class="hljs-string">"Ops:"</span>, ops.Load())
</code></pre>
<h2 id="advanced-patterns">Advanced Patterns</h2>
<h4 id="worker-pool">Worker Pool</h4>
<p>Spawning <code>go func()</code> for every HTTP then you will get Out-Of-Memory (OOM) errors. Use a Worker Pool to throttle concurrency.</p>
<pre><code class="lang-go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(id <span class="hljs-type">int</span>, jobs &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, results <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> j := <span class="hljs-keyword">range</span> jobs {
        fmt.Printf(<span class="hljs-string">"worker %d processing job %d\n"</span>, id, j)
        time.Sleep(time.Second) <span class="hljs-comment">// Simulate work</span>
        results &lt;- j * <span class="hljs-number">2</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">const</span> numJobs = <span class="hljs-number">100</span>
    <span class="hljs-keyword">const</span> numWorkers = <span class="hljs-number">5</span>

    jobs := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, numJobs)
    results := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, numJobs)

    <span class="hljs-comment">// Start fixed number of workers</span>
    <span class="hljs-keyword">for</span> w := <span class="hljs-number">1</span>; w &lt;= numWorkers; w++ {
        <span class="hljs-keyword">go</span> worker(w, jobs, results)
    }

    <span class="hljs-comment">// Send jobs</span>
    <span class="hljs-keyword">for</span> j := <span class="hljs-number">1</span>; j &lt;= numJobs; j++ {
        jobs &lt;- j
    }
    <span class="hljs-built_in">close</span>(jobs) <span class="hljs-comment">// Signal workers that no more jobs are coming</span>

    <span class="hljs-comment">// Collect results</span>
    <span class="hljs-keyword">for</span> a := <span class="hljs-number">1</span>; a &lt;= numJobs; a++ {
        &lt;-results
    }
}
</code></pre>
<h4 id="errgroup-golangorgxsyncerrgroup">ErrGroup (<code>golang.org/x/sync/errgroup</code>)</h4>
<p>The modern "Senior" alternative to <code>sync.WaitGroup</code>. It handles:</p>
<ol>
<li>Waiting for goroutines.</li>
<li>Error propagation (returns the first error encountered).</li>
<li>Context cancellation (if one fails, cancel the others).</li>
</ol>
<pre><code class="lang-go"><span class="hljs-keyword">import</span> <span class="hljs-string">"golang.org/x/sync/errgroup"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    g, ctx := errgroup.WithContext(context.Background())
    urls := []<span class="hljs-type">string</span>{<span class="hljs-string">"http://google.com"</span>, <span class="hljs-string">"http://bad-url.com"</span>, <span class="hljs-string">"http://bing.com"</span>}

    <span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urls {
        url := url <span class="hljs-comment">// Capture loop var (standard in Go &lt; 1.22)</span>
        g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
            <span class="hljs-comment">// Check context before working</span>
            <span class="hljs-keyword">if</span> ctx.Err() != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> ctx.Err()
            }
            resp, err := http.Get(url)
            <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
                resp.Body.Close()
            }
            <span class="hljs-keyword">return</span> err <span class="hljs-comment">// If this returns error, all other Gs get cancelled via ctx</span>
        })
    }

    <span class="hljs-keyword">if</span> err := g.Wait(); err != <span class="hljs-literal">nil</span> {
        fmt.Println(<span class="hljs-string">"Error encountered:"</span>, err)
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"All fetches successful"</span>)
    }
}
</code></pre>
<h2 id="goroutine-leak">Goroutine Leak</h2>
<p>Real world goroutine leak</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/pull/135078" target="_blank">https://github.com/kubernetes/kubernetes/pull/135078</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/134939" target="_blank">https://github.com/kubernetes/kubernetes/issues/134939</a></li>
</ul>
<p>Leaked goroutines cause:</p>
<ul>
<li>Increased memory consumption (each goroutine has its own stack)</li>
<li>Increased scheduling overhead (scheduler now handles more runnable goroutines)</li>
<li>Potential exhaustion of system resources</li>
</ul>
<pre><code class="lang-go"><span class="hljs-comment">// Lost goroutine due to async operations not tied to context</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// do db operation / send notification</span>
        <span class="hljs-comment">// <span class="hljs-doctag">BUG:</span> ignores r.Context()</span>
    }()
}
<span class="hljs-comment">// Fix ‚úÖ</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handler</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    ctx := r.Context()

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> &lt;-time.After(time.Second):
            <span class="hljs-comment">// finish work</span>
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():    <span class="hljs-comment">// client disconnected ‚Üí abort</span>
            <span class="hljs-keyword">return</span>
        }
    }()
}
</code></pre>
<pre><code class="lang-go"><span class="hljs-comment">// Forgetting to stop goroutines when using select + channels</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doWork</span><span class="hljs-params">(ch <span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">for</span> {
            <span class="hljs-keyword">select</span> {
            <span class="hljs-keyword">case</span> &lt;-ch:
                <span class="hljs-comment">// do something</span>
            }
            <span class="hljs-comment">// <span class="hljs-doctag">BUG:</span> no default / no cancel path</span>
        }
    }()
}
<span class="hljs-comment">// Fix ‚úÖ</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doWork</span><span class="hljs-params">(ctx context.Context, ch <span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">for</span> {
            <span class="hljs-keyword">select</span> {
            <span class="hljs-keyword">case</span> &lt;-ch:
                <span class="hljs-comment">// do something</span>
            <span class="hljs-keyword">case</span> &lt;-ctx.Done():  <span class="hljs-comment">// required exit</span>
                <span class="hljs-keyword">return</span>
            }
        }
    }()
}
</code></pre>
<pre><code class="lang-go"><span class="hljs-comment">// Goroutine waiting forever on a channel (blocked read/write)</span>
<span class="hljs-comment">// If ch stops receiving values or is never closed, worker() blocks forever.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(ch &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> {
        v := &lt;-ch   <span class="hljs-comment">// blocked forever if no one sends to ch</span>
        fmt.Println(v)
    }
}
<span class="hljs-comment">// Fix ‚úÖ</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">worker</span><span class="hljs-params">(ctx context.Context, ch &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)</span></span> {
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> v, ok := &lt;-ch:
            <span class="hljs-keyword">if</span> !ok {           <span class="hljs-comment">// channel closed ‚Üí exit goroutine</span>
                <span class="hljs-keyword">return</span>
            }
            fmt.Println(v)
        <span class="hljs-keyword">case</span> &lt;-ctx.Done():     <span class="hljs-comment">// cancellation ‚Üí exit goroutine</span>
            <span class="hljs-keyword">return</span>
        }
    }
}
</code></pre>
<pre><code class="lang-go">
<span class="hljs-comment">// Deadlock inside goroutine due to mutual channel dependency</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        &lt;-ch1
        ch2 &lt;- <span class="hljs-number">1</span> <span class="hljs-comment">// waits forever if main never reads ch2</span>
    }()

    &lt;-ch2 <span class="hljs-comment">// waits forever if goroutine never writes to ch2</span>
}
<span class="hljs-comment">// Fix ‚úÖ</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)
    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// buffered channel prevents deadlock</span>

    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        &lt;-ch1
        ch2 &lt;- <span class="hljs-number">1</span>
    }()

    ch1 &lt;- <span class="hljs-number">1</span>
    fmt.Println(&lt;-ch2)
}
</code></pre>
<h3 id="detect-goroutine-leak-with">Detect Goroutine Leak with</h3>
<ul>
<li><a href="https://github.com/uber-go/goleak" target="_blank">https://github.com/uber-go/goleak</a></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="strings.html" class="navigation navigation-prev " aria-label="Previous page: Strings">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../rag/" class="navigation navigation-next " aria-label="Next page: RAG">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Goroutine","level":"1.3.2","depth":2,"next":{"title":"RAG","level":"1.4","depth":1,"path":"rag/README.md","ref":"rag/README.md","articles":[{"title":"Crawling Result","level":"1.4.1","depth":2,"path":"rag/crawling-result.md","ref":"rag/crawling-result.md","articles":[]},{"title":"Chunking","level":"1.4.2","depth":2,"path":"rag/chunking.md","ref":"rag/chunking.md","articles":[]}]},"previous":{"title":"Strings","level":"1.3.1","depth":2,"path":"golang/strings.md","ref":"golang/strings.md","articles":[]},"dir":"ltr"},"config":{"plugins":["hints"],"root":"./","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"My Blog","language":"en","gitbook":"*"},"file":{"path":"golang/goroutine.md","mtime":"2025-12-06T08:55:36.832Z","type":"markdown"},"gitbook":{"version":"6.1.4","time":"2025-12-06T11:33:05.637Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

